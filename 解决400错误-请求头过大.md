# è§£å†³ 400 Bad Request - è¯·æ±‚å¤´æˆ– Cookie è¿‡å¤§

## ðŸ” é”™è¯¯è¯´æ˜Ž

é”™è¯¯ä¿¡æ¯ï¼š`400 Bad Request - Request Header Or Cookie Too Large`

**åŽŸå› **ï¼šNginx é»˜è®¤çš„è¯·æ±‚å¤´ç¼“å†²åŒºå¤§å°å¤ªå°ï¼Œå½“è¯·æ±‚å¤´æˆ– Cookie è¾ƒå¤§æ—¶ä¼šè¶…è¿‡é™åˆ¶ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³• 1ï¼šä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæœ€ç®€å•ï¼ŒæŽ¨èï¼‰

```bash
# è¿è¡Œä¿®å¤è„šæœ¬
sudo bash ä¿®å¤400é”™è¯¯.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ·»åŠ æˆ–æ›´æ–°ç¼“å†²åŒºé…ç½®ï¼ˆä½¿ç”¨æ›´å¤§çš„å€¼ï¼‰
- æµ‹è¯•é…ç½®
- é‡æ–°åŠ è½½ Nginx

### æ–¹æ³• 2ï¼šä¿®æ”¹ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼ˆæ‰‹åŠ¨ï¼‰

ç¼–è¾‘ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ç¼“å†²åŒºè®¾ç½®ï¼š

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vi /www/server/panel/vhost/nginx/qk-paper-search.conf
# æˆ–
sudo nano /www/server/panel/vhost/nginx/qk-paper-search.conf
```

åœ¨ `server {` å—ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```nginx
server {
    listen 80 default_server;
    server_name _;

    # å¢žåŠ ç¼“å†²åŒºå¤§å°ï¼ˆè§£å†³ 400 é”™è¯¯ï¼‰
    client_header_buffer_size 128k;        # å¢žåŠ åˆ° 128k
    large_client_header_buffers 8 128k;    # å¢žåŠ åˆ° 8ä¸ª128kç¼“å†²åŒº
    client_body_buffer_size 256k;          # å¢žåŠ åˆ° 256k

    client_max_body_size 100M;

    # ... å…¶ä»–é…ç½® ...
}
```

### æ–¹æ³• 3ï¼šä½¿ç”¨ sed å¿«é€Ÿæ·»åŠ ï¼ˆå¢žå¼ºç‰ˆï¼‰

```bash
# åœ¨ server { å—ä¸­æ·»åŠ æ›´å¤§çš„ç¼“å†²åŒºé…ç½®
sudo sed -i '/server {/a\    client_header_buffer_size 128k;\n    large_client_header_buffers 8 128k;\n    client_body_buffer_size 256k;' /www/server/panel/vhost/nginx/qk-paper-search.conf

# å¦‚æžœé…ç½®å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤å†æ·»åŠ 
sudo sed -i '/client_header_buffer_size/d; /large_client_header_buffers/d; /client_body_buffer_size/d' /www/server/panel/vhost/nginx/qk-paper-search.conf
sudo sed -i '/server {/a\    client_header_buffer_size 128k;\n    large_client_header_buffers 8 128k;\n    client_body_buffer_size 256k;' /www/server/panel/vhost/nginx/qk-paper-search.conf

# æµ‹è¯•é…ç½®
/www/server/nginx/sbin/nginx -t

# é‡æ–°åŠ è½½
/www/server/nginx/sbin/nginx -s reload
```

### æ–¹æ³• 4ï¼šå®Œæ•´æ›´æ–°é…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºå®Œæ•´çš„é…ç½®æ–‡ä»¶ï¼ˆåŒ…å«ç¼“å†²åŒºè®¾ç½®ï¼‰
sudo tee /www/server/panel/vhost/nginx/qk-paper-search.conf > /dev/null << 'EOF'
server {
    listen 80 default_server;
    server_name _;

    # å¢žåŠ ç¼“å†²åŒºå¤§å°ï¼ˆè§£å†³ 400 é”™è¯¯ï¼‰
    client_header_buffer_size 64k;
    large_client_header_buffers 4 64k;
    client_body_buffer_size 128k;

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
EOF

# æµ‹è¯•å¹¶é‡æ–°åŠ è½½
/www/server/nginx/sbin/nginx -t && /www/server/nginx/sbin/nginx -s reload
```

## ðŸ“ é…ç½®è¯´æ˜Ž

### å…³é”®é…ç½®å‚æ•°

```nginx
# å®¢æˆ·ç«¯è¯·æ±‚å¤´ç¼“å†²åŒºå¤§å°
client_header_buffer_size 64k;

# å¤§åž‹å®¢æˆ·ç«¯è¯·æ±‚å¤´ç¼“å†²åŒºçš„æ•°é‡å’Œå¤§å°
# æ ¼å¼ï¼šæ•°é‡ å¤§å°ï¼ˆæ¯ä¸ªï¼‰
large_client_header_buffers 4 64k;

# å®¢æˆ·ç«¯è¯·æ±‚ä½“ç¼“å†²åŒºå¤§å°
client_body_buffer_size 128k;

# æœ€å¤§å®¢æˆ·ç«¯è¯·æ±‚ä½“å¤§å°ï¼ˆå·²ç»é…ç½®ï¼‰
client_max_body_size 100M;
```

### å‚æ•°è¯´æ˜Ž

- **client_header_buffer_size**ï¼šé»˜è®¤ 1kï¼Œç”¨äºŽæ™®é€šè¯·æ±‚å¤´
- **large_client_header_buffers**ï¼šé»˜è®¤ 4 8kï¼Œç”¨äºŽè¶…å¤§åž‹è¯·æ±‚å¤´ï¼ˆ4 ä¸ª 64k ç¼“å†²åŒºï¼‰
- **client_body_buffer_size**ï¼šé»˜è®¤ 8k æˆ– 16kï¼Œç”¨äºŽè¯·æ±‚ä½“

## ðŸš€ ä¸€é”®ä¿®å¤å‘½ä»¤

```bash
# ä¸€é”®ä¿®å¤ï¼ˆå¢žå¼ºç‰ˆï¼Œä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒºï¼‰
sudo bash ä¿®å¤400é”™è¯¯.sh

# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ
sudo sed -i '/client_header_buffer_size/d; /large_client_header_buffers/d; /client_body_buffer_size/d' /www/server/panel/vhost/nginx/qk-paper-search.conf && \
sudo sed -i '/server {/a\    client_header_buffer_size 128k;\n    large_client_header_buffers 8 128k;\n    client_body_buffer_size 256k;' /www/server/panel/vhost/nginx/qk-paper-search.conf && \
/www/server/nginx/sbin/nginx -t && \
/www/server/nginx/sbin/nginx -s reload && \
echo "âœ… ä¿®å¤å®Œæˆï¼è¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åŽè®¿é—® http://120.55.70.199"
```

## ðŸ” éªŒè¯ä¿®å¤

ä¿®å¤åŽéªŒè¯ï¼š

```bash
# 1. æŸ¥çœ‹é…ç½®æ–‡ä»¶
cat /www/server/panel/vhost/nginx/qk-paper-search.conf | grep -A 3 "server {"

# 2. æµ‹è¯•é…ç½®
/www/server/nginx/sbin/nginx -t

# 3. é‡æ–°è®¿é—®ç½‘ç«™
curl http://120.55.70.199
```

## âš ï¸ é‡è¦æç¤ºï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜

ä¿®å¤é…ç½®åŽï¼Œ**å¿…é¡»æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ Cookie**ï¼š

### æ–¹æ³• 1ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- **Chrome/Edge**ï¼š`Ctrl + Shift + Delete` â†’ æ¸…é™¤ Cookie å’Œç¼“å­˜
- **Firefox**ï¼š`Ctrl + Shift + Delete` â†’ æ¸…é™¤ Cookie å’Œç¼“å­˜

### æ–¹æ³• 2ï¼šä½¿ç”¨æ— ç—•æ¨¡å¼
- **Chrome/Edge**ï¼š`Ctrl + Shift + N`
- **Firefox**ï¼š`Ctrl + Shift + P`

### æ–¹æ³• 3ï¼šæ¸…é™¤å•ä¸ªç½‘ç«™ Cookie
1. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
2. ç‚¹å‡»"Application"ï¼ˆChromeï¼‰æˆ–"å­˜å‚¨"ï¼ˆFirefoxï¼‰
3. æ‰¾åˆ° Cookie â†’ `http://120.55.70.199`
4. å³é”®åˆ é™¤æ‰€æœ‰ Cookie

### ä¸ºä»€ä¹ˆéœ€è¦æ¸…é™¤ç¼“å­˜ï¼Ÿ
æµè§ˆå™¨å¯èƒ½å·²ç»ç¼“å­˜äº†é”™è¯¯çš„å“åº”ï¼Œå³ä½¿æœåŠ¡å™¨é…ç½®å·²ä¿®å¤ï¼Œæµè§ˆå™¨ä»å¯èƒ½ä½¿ç”¨ç¼“å­˜è¿”å›ž 400 é”™è¯¯ã€‚

## ðŸŽ¯ å®Œæ•´é…ç½®ç¤ºä¾‹

ä¿®å¤åŽçš„å®Œæ•´é…ç½®åº”è¯¥æ˜¯è¿™æ ·çš„ï¼ˆä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒºå€¼ï¼‰ï¼š

```nginx
server {
    listen 80 default_server;
    server_name _;

    # å¢žåŠ ç¼“å†²åŒºå¤§å°ï¼ˆè§£å†³ 400 é”™è¯¯ï¼‰
    client_header_buffer_size 128k;        # å¢žåŠ åˆ° 128k
    large_client_header_buffers 8 128k;    # å¢žåŠ åˆ° 8ä¸ª128kç¼“å†²åŒº
    client_body_buffer_size 256k;          # å¢žåŠ åˆ° 256k

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
```

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [fix-bt-nginx-site.sh](fix-bt-nginx-site.sh) - ç«™ç‚¹é…ç½®è„šæœ¬
- [ä¸€é”®ä¿®å¤å®å¡”ç«™ç‚¹.sh](ä¸€é”®ä¿®å¤å®å¡”ç«™ç‚¹.sh) - ä¸€é”®ä¿®å¤è„šæœ¬
- [æ•…éšœæŽ’é™¤æ¸…å•.md](æ•…éšœæŽ’é™¤æ¸…å•.md) - å…¶ä»–å¸¸è§é—®é¢˜

---

**å¿«é€Ÿä¿®å¤**ï¼š
```bash
# ä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæŽ¨èï¼‰
sudo bash ä¿®å¤400é”™è¯¯.sh

# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œï¼ˆå¢žå¼ºç‰ˆï¼‰
sudo sed -i '/client_header_buffer_size/d; /large_client_header_buffers/d; /client_body_buffer_size/d' /www/server/panel/vhost/nginx/qk-paper-search.conf && \
sudo sed -i '/server {/a\    client_header_buffer_size 128k;\n    large_client_header_buffers 8 128k;\n    client_body_buffer_size 256k;' /www/server/panel/vhost/nginx/qk-paper-search.conf && \
/www/server/nginx/sbin/nginx -t && /www/server/nginx/sbin/nginx -s reload
```

