# è§£å†³å®å¡”é¢æ¿"æ²¡æœ‰æ‰¾åˆ°ç«™ç‚¹" - ç»ˆææ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

åœ¨å®å¡”é¢æ¿ç¯å¢ƒä¸‹ï¼Œå‡ºç°"æ²¡æœ‰æ‰¾åˆ°ç«™ç‚¹"é”™è¯¯çš„å¸¸è§åŸå› ï¼š

1. **é»˜è®¤ç«™ç‚¹å¹²æ‰°** - å®å¡”é»˜è®¤ç«™ç‚¹ä¹Ÿåœ¨ç›‘å¬ 80 ç«¯å£
2. **é…ç½®æ–‡ä»¶æœªåŠ è½½** - Nginx ä¸»é…ç½®æœªåŒ…å« vhost ç›®å½•
3. **server_name ä¸åŒ¹é…** - server_name é…ç½®ä¸æ­£ç¡®
4. **é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§** - å¤šä¸ªç«™ç‚¹é…ç½®å†²çª

## âœ… ç»ˆæè§£å†³æ–¹æ¡ˆ

### æ–¹æ³• 1ï¼šä½¿ç”¨å…¨é¢æ£€æŸ¥è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œå…¨é¢æ£€æŸ¥å’Œä¿®å¤è„šæœ¬
sudo bash æ£€æŸ¥å¹¶ä¿®å¤å®å¡”ç«™ç‚¹é…ç½®.sh
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ’æŸ¥å’Œä¿®å¤

#### æ­¥éª¤ 1ï¼šæ£€æŸ¥æ‰€æœ‰ç«™ç‚¹é…ç½®

```bash
# æŸ¥çœ‹æ‰€æœ‰ç«™ç‚¹é…ç½®
ls -la /www/server/panel/vhost/nginx/

# æŸ¥çœ‹æ¯ä¸ªé…ç½®æ–‡ä»¶
cat /www/server/panel/vhost/nginx/*.conf | grep -E "listen|server_name"
```

#### æ­¥éª¤ 2ï¼šåˆ é™¤æˆ–ç¦ç”¨é»˜è®¤ç«™ç‚¹

```bash
# æŸ¥æ‰¾é»˜è®¤ç«™ç‚¹é…ç½®
find /www/server/panel/vhost/nginx/ -name "*default*" -o -name "*phpmyadmin*"

# å¦‚æœæ‰¾åˆ°é»˜è®¤ç«™ç‚¹ï¼Œé‡å‘½åæˆ–åˆ é™¤
sudo mv /www/server/panel/vhost/nginx/default.conf /www/server/panel/vhost/nginx/default.conf.bak
sudo mv /www/server/panel/vhost/nginx/0.default.conf /www/server/panel/vhost/nginx/0.default.conf.bak
```

#### æ­¥éª¤ 3ï¼šç¡®ä¿æˆ‘ä»¬çš„é…ç½®æ­£ç¡®

```bash
# æ£€æŸ¥æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶
cat /www/server/panel/vhost/nginx/qk-paper-search.conf

# ç¡®ä¿ server_name æ˜¯ _
grep server_name /www/server/panel/vhost/nginx/qk-paper-search.conf

# ç¡®ä¿ç›‘å¬ 80 ç«¯å£
grep "listen 80" /www/server/panel/vhost/nginx/qk-paper-search.conf
```

#### æ­¥éª¤ 4ï¼šæ£€æŸ¥é…ç½®åŠ è½½é¡ºåº

```bash
# æŸ¥çœ‹ Nginx åŠ è½½çš„æ‰€æœ‰ server å—
/www/server/nginx/sbin/nginx -T 2>/dev/null | grep -B 5 -A 10 "listen 80"
```

## ğŸ¯ åœ¨å®å¡”é¢æ¿ä¸­æ“ä½œ

### åˆ é™¤é»˜è®¤ç«™ç‚¹

1. **ç™»å½•å®å¡”é¢æ¿**
2. **ç‚¹å‡»"ç½‘ç«™"èœå•**
3. **æ‰¾åˆ°é»˜è®¤ç«™ç‚¹**ï¼ˆå¦‚ "default" æˆ– "phpMyAdmin"ï¼‰
4. **ç‚¹å‡»ç«™ç‚¹å³ä¾§çš„"åˆ é™¤"**ï¼ˆæˆ–"åœç”¨"ï¼‰
5. **ç¡®è®¤åˆ é™¤**

### æ£€æŸ¥ç«™ç‚¹åˆ—è¡¨

1. **ç™»å½•å®å¡”é¢æ¿**
2. **ç‚¹å‡»"ç½‘ç«™"èœå•**
3. **æŸ¥çœ‹ç«™ç‚¹åˆ—è¡¨**ï¼š
   - å¦‚æœæœ‰å¤šä¸ªç«™ç‚¹ï¼Œæ£€æŸ¥å®ƒä»¬æ˜¯å¦éƒ½ç»‘å®šåˆ° 80 ç«¯å£
   - ç¡®ä¿åªæœ‰ä¸€ä¸ªç«™ç‚¹ç›‘å¬ 80 ç«¯å£ï¼ˆé™¤äº†æˆ‘ä»¬çš„ç«™ç‚¹ï¼‰

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤é›†åˆ

### ä¸€é”®ä¿®å¤ï¼ˆå¤åˆ¶ç²˜è´´è¿è¡Œï¼‰

```bash
# 1. åˆ›å»ºæ­£ç¡®çš„é…ç½®æ–‡ä»¶
sudo tee /www/server/panel/vhost/nginx/qk-paper-search.conf > /dev/null << 'EOF'
server {
    listen 80 default_server;
    server_name _;
    client_max_body_size 100M;
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
EOF

# 2. ç¦ç”¨é»˜è®¤ç«™ç‚¹
sudo mv /www/server/panel/vhost/nginx/default.conf /www/server/panel/vhost/nginx/default.conf.bak 2>/dev/null || true
sudo mv /www/server/panel/vhost/nginx/0.default.conf /www/server/panel/vhost/nginx/0.default.conf.bak 2>/dev/null || true

# 3. æµ‹è¯•å¹¶é‡æ–°åŠ è½½
/www/server/nginx/sbin/nginx -t && \
/www/server/nginx/sbin/nginx -s reload && \
echo "âœ… ä¿®å¤å®Œæˆï¼è®¿é—® http://120.55.70.199"
```

### å…³é”®ç‚¹ï¼šæ·»åŠ  default_server

æ³¨æ„é…ç½®ä¸­æ·»åŠ äº† `default_server`ï¼š

```nginx
listen 80 default_server;
```

è¿™ä¼šè®©è¿™ä¸ªç«™ç‚¹æˆä¸º 80 ç«¯å£çš„é»˜è®¤ç«™ç‚¹ï¼Œä¼˜å…ˆåŒ¹é…æ‰€æœ‰è¯·æ±‚ã€‚

## ğŸ” è¯¦ç»†è¯Šæ–­æ­¥éª¤

### 1. æ£€æŸ¥æ‰€æœ‰ç›‘å¬ 80 ç«¯å£çš„ç«™ç‚¹

```bash
# æŸ¥çœ‹æ‰€æœ‰ç«™ç‚¹é…ç½®ä¸­ç›‘å¬ 80 ç«¯å£çš„
grep -r "listen 80" /www/server/panel/vhost/nginx/

# æŸ¥çœ‹ Nginx å®é™…åŠ è½½çš„é…ç½®
/www/server/nginx/sbin/nginx -T 2>/dev/null | grep -B 3 -A 3 "listen 80"
```

### 2. æ£€æŸ¥é…ç½®ä¼˜å…ˆçº§

```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåºï¼ˆæŒ‰æ–‡ä»¶åæ’åºï¼‰
ls -1 /www/server/panel/vhost/nginx/*.conf

# Nginx ä¼šæŒ‰æ–‡ä»¶åé¡ºåºåŠ è½½ï¼Œå¦‚æœæœ‰å¤šä¸ª default_serverï¼Œæœ€åä¸€ä¸ªç”Ÿæ•ˆ
```

### 3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /www/server/nginx/logs/error.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
tail -n 50 /www/server/nginx/logs/error.log
```

### 4. æµ‹è¯•æœ¬åœ°è®¿é—®

```bash
# æµ‹è¯•ä¸åŒæ–¹å¼è®¿é—®
curl -H "Host: 120.55.70.199" http://127.0.0.1
curl http://127.0.0.1
curl http://120.55.70.199
```

## ğŸ“ å®Œæ•´çš„æ­£ç¡®é…ç½®

ç¡®ä¿é…ç½®æ–‡ä»¶ `/www/server/panel/vhost/nginx/qk-paper-search.conf` å†…å®¹å¦‚ä¸‹ï¼š

```nginx
server {
    listen 80 default_server;  # æ·»åŠ  default_server
    server_name _;

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
```

**å…³é”®æ”¹åŠ¨**ï¼š`listen 80 default_server;` - è®¾ç½®ä¸ºé»˜è®¤ç«™ç‚¹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ£€æŸ¥å¹¶ä¿®å¤å®å¡”ç«™ç‚¹é…ç½®.sh](æ£€æŸ¥å¹¶ä¿®å¤å®å¡”ç«™ç‚¹é…ç½®.sh) - å…¨é¢æ£€æŸ¥è„šæœ¬
- [fix-bt-nginx-site.sh](fix-bt-nginx-site.sh) - åŸºç¡€ä¿®å¤è„šæœ¬
- [å®å¡”é¢æ¿æ·»åŠ ç«™ç‚¹æŒ‡å—.md](å®å¡”é¢æ¿æ·»åŠ ç«™ç‚¹æŒ‡å—.md) - å›¾å½¢ç•Œé¢æ“ä½œ

---

**å¿«é€Ÿä¿®å¤**ï¼š
```bash
sudo bash æ£€æŸ¥å¹¶ä¿®å¤å®å¡”ç«™ç‚¹é…ç½®.sh
```




