# éƒ¨ç½²åˆ°å®å¡”é¢æ¿ - å®Œæ•´æ­¥éª¤

## ðŸ“‹ æ­¥éª¤æ¦‚è§ˆ

1. åˆ›å»ºç«™ç‚¹é…ç½®æ–‡ä»¶åˆ°å®å¡” vhost ç›®å½•
2. æµ‹è¯•å¹¶é‡æ–°åŠ è½½ Nginx
3. ç¡®ä¿åº”ç”¨æœåŠ¡è¿è¡Œ
4. è®¿é—®åº”ç”¨

## ðŸš€ å®Œæ•´æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»ºç«™ç‚¹é…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºå®å¡”ç«™ç‚¹é…ç½®æ–‡ä»¶
sudo vi /www/server/panel/vhost/nginx/qk-paper-search.conf
# æˆ–
sudo nano /www/server/panel/vhost/nginx/qk-paper-search.conf
```

å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼ˆå·²ä¿®æ­£é”™è¯¯ï¼Œä½¿ç”¨å®å¡”æ—¥å¿—è·¯å¾„ï¼‰ï¼š

```nginx
server {
    listen 80;
    server_name _;

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
```

### æ­¥éª¤ 2ï¼šä½¿ç”¨è„šæœ¬å¿«é€Ÿåˆ›å»º

```bash
# ä½¿ç”¨ cat å‘½ä»¤ç›´æŽ¥åˆ›å»º
sudo tee /www/server/panel/vhost/nginx/qk-paper-search.conf > /dev/null << 'EOF'
server {
    listen 80;
    server_name _;

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
EOF
```

### æ­¥éª¤ 3ï¼šæµ‹è¯•é…ç½®

```bash
# æµ‹è¯• Nginx é…ç½®
/www/server/nginx/sbin/nginx -t
```

å¦‚æžœçœ‹åˆ° `syntax is ok` å’Œ `test is successful`ï¼Œè¯´æ˜Žé…ç½®æ­£ç¡®ã€‚

### æ­¥éª¤ 4ï¼šé‡æ–°åŠ è½½ Nginx

```bash
# é‡æ–°åŠ è½½ Nginx
/www/server/nginx/sbin/nginx -s reload

# æˆ–ä½¿ç”¨å®å¡”å‘½ä»¤
bt reload nginx
```

### æ­¥éª¤ 5ï¼šç¡®ä¿åº”ç”¨æœåŠ¡è¿è¡Œ

```bash
# æ£€æŸ¥åº”ç”¨æœåŠ¡çŠ¶æ€
sudo systemctl status qk-paper-search

# å¦‚æžœæœªè¿è¡Œï¼Œå¯åŠ¨å®ƒ
sudo systemctl start qk-paper-search
sudo systemctl enable qk-paper-search

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 8000
```

### æ­¥éª¤ 6ï¼šéªŒè¯è®¿é—®

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæµ‹è¯•
curl http://127.0.0.1
curl http://120.55.70.199

# åœ¨æµè§ˆå™¨è®¿é—®
http://120.55.70.199
```

## ðŸ”§ ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
# ä¸€é”®åˆ›å»ºé…ç½®å¹¶é‡æ–°åŠ è½½
sudo tee /www/server/panel/vhost/nginx/qk-paper-search.conf > /dev/null << 'EOF'
server {
    listen 80;
    server_name _;
    client_max_body_size 100M;
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    location /static {
        alias /opt/qk/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    access_log /www/server/nginx/logs/qk-paper-search-access.log;
    error_log /www/server/nginx/logs/qk-paper-search-error.log;
}
EOF

# æµ‹è¯•å¹¶é‡æ–°åŠ è½½
/www/server/nginx/sbin/nginx -t && \
/www/server/nginx/sbin/nginx -s reload && \
echo "âœ… é…ç½®å·²éƒ¨ç½²ï¼è®¿é—® http://120.55.70.199"
```

## ðŸ“ é…ç½®è¯´æ˜Ž

### ä¿®æ­£çš„é”™è¯¯

åŽŸé…ç½®ä¸­æœ‰ä¸€ä¸ªé”™è¯¯ï¼š
```nginx
# é”™è¯¯ï¼š
return 301 https://$server_name _;

# æ­£ç¡®ï¼š
return 301 https://$server_name$request_uri;
```

### å®å¡”é¢æ¿ç‰¹æ®Šè¯´æ˜Ž

1. **æ—¥å¿—è·¯å¾„**ï¼šä½¿ç”¨å®å¡”è·¯å¾„ `/www/server/nginx/logs/` è€Œä¸æ˜¯ `/var/log/nginx/`
2. **é…ç½®æ–‡ä»¶ä½ç½®**ï¼šå¿…é¡»æ”¾åœ¨ `/www/server/panel/vhost/nginx/` ç›®å½•
3. **ä¸»é…ç½®**ï¼šé€šå¸¸ä¼šè‡ªåŠ¨åŒ…å« vhost ç›®å½•ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹

## ðŸ” æ•…éšœæŽ’æŸ¥

### å¦‚æžœä»æ— æ³•è®¿é—®

```bash
# 1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /www/server/panel/vhost/nginx/qk-paper-search.conf

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /www/server/nginx/logs/error.log

# 3. æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f /www/server/nginx/logs/qk-paper-search-access.log

# 4. æ£€æŸ¥ Nginx ä¸»é…ç½®
cat /www/server/nginx/conf/nginx.conf | grep vhost

# 5. æ£€æŸ¥åº”ç”¨æœåŠ¡
systemctl status qk-paper-search
netstat -tlnp | grep 8000
```

### æ£€æŸ¥é…ç½®æ˜¯å¦åŠ è½½

```bash
# æŸ¥çœ‹ Nginx åŠ è½½çš„æ‰€æœ‰ server å—
/www/server/nginx/sbin/nginx -T | grep -A 10 "server_name _"
```

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [fix-bt-nginx-site.sh](fix-bt-nginx-site.sh) - è‡ªåŠ¨ä¿®å¤è„šæœ¬
- [å®å¡”é¢æ¿Nginxé…ç½®è¯´æ˜Ž.md](å®å¡”é¢æ¿Nginxé…ç½®è¯´æ˜Ž.md) - è¯¦ç»†è¯´æ˜Ž
- [å®å¡”nginxé…ç½®-ä¿®æ­£ç‰ˆ.conf](å®å¡”nginxé…ç½®-ä¿®æ­£ç‰ˆ.conf) - ä¿®æ­£åŽçš„é…ç½®æ–‡ä»¶

---

**å¿«é€Ÿéƒ¨ç½²**ï¼š
```bash
sudo bash fix-bt-nginx-site.sh
```




