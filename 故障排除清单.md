# 部署故障排除清单

遇到问题时的快速检查清单。

## 🔴 常见错误及解决方案

### 1. `nano: command not found`

**解决方案**：
- 安装 nano：`sudo apt install nano -y`
- 或使用 vi：`vi 文件名`（按 `i` 编辑，按 `Esc` 后输入 `:wq` 保存）
- 详细说明：[解决nano命令不存在.md](解决nano命令不存在.md)

### 2. `sudo: ./deploy/deploy.sh: command not found`

**解决方案**：
```bash
# 1. 添加执行权限
chmod +x deploy/deploy.sh

# 2. 修复行结束符（如果从 Windows 上传）
dos2unix deploy/deploy.sh

# 3. 再次运行
sudo ./deploy/deploy.sh

# 或者直接用 bash 运行
sudo bash deploy/deploy.sh
```
- 详细说明：[解决deploy脚本无法运行.md](解决deploy脚本无法运行.md)

### 3. `Permission denied`

**可能原因**：
- 脚本没有执行权限
- 目录权限不足

**解决方案**：
```bash
# 添加执行权限
chmod +x deploy/deploy.sh

# 检查文件权限
ls -l deploy/deploy.sh

# 如果目录权限不足，调整目录权限
sudo chown -R $USER:$USER /opt/qk
```

### 4. `bad interpreter: /bin/bash^M`

**原因**：行结束符问题（Windows CRLF vs Linux LF）

**解决方案**：
```bash
# 安装 dos2unix
sudo apt install dos2unix -y

# 转换文件
dos2unix deploy/deploy.sh

# 或者使用 sed
sed -i 's/\r$//' deploy/deploy.sh
```

### 5. `错误: 未找到 requirements.txt`

**原因**：项目文件没有完整上传，或部署脚本在错误的目录运行

**解决方案**：
```bash
# 1. 检查当前目录和文件
pwd
ls -la requirements.txt

# 2. 如果文件不存在，手动创建
cat > requirements.txt << 'EOF'
requests>=2.31.0
PyYAML>=6.0.2
dataclasses-json>=0.6.7
tenacity>=9.0.0
fastapi>=0.115.0
uvicorn[standard]>=0.30.0
jinja2>=3.1.4
python-multipart>=0.0.9
EOF

# 3. 或者确保项目文件已完整上传
```
- 详细说明：[解决requirements.txt未找到.md](解决requirements.txt未找到.md)

### 6. `No such file or directory`

**检查步骤**：
```bash
# 检查当前目录
pwd

# 检查文件是否存在
ls -la deploy/deploy.sh

# 检查文件内容（应该看到 #!/bin/bash）
head -n 1 deploy/deploy.sh
```

### 7. 服务启动失败

**检查步骤**：
```bash
# 查看服务状态
sudo systemctl status qk-paper-search

# 查看详细日志
sudo journalctl -u qk-paper-search -n 50

# 检查配置文件语法
python3 -c "from src.config import load_config; load_config(None)"
```

### 8. `ERROR: Could not find a version that satisfies the requirement`

**原因**：pip 版本太旧或系统环境较旧，无法找到新版本的包（如 fastapi>=0.100.0 但只有 0.83.0）

**解决方案**：
```bash
# 1. 升级 pip（最重要！）
python3 -m pip install --upgrade pip

# 2. 清除缓存
pip cache purge

# 3. 尝试使用兼容版本（按顺序尝试）
pip install -r requirements-old.txt          # 中等兼容性
pip install -r requirements-minimal.txt      # 最低兼容性

# 4. 如果都失败，不指定版本安装（使用默认最新可用版本）
pip install requests PyYAML dataclasses-json tenacity fastapi "uvicorn[standard]" jinja2 python-multipart
```
- 快速修复：[快速修复pip安装问题.md](快速修复pip安装问题.md)
- 详细说明：[解决pip安装失败.md](解决pip安装失败.md)

### 9. `cp: cannot create regular file '/etc/nginx/sites-available/...': No such file or directory`

**原因**：Nginx 配置目录不存在

**解决方案**：
```bash
# 1. 安装 Nginx（如果未安装）
sudo apt install nginx -y  # Ubuntu/Debian
# 或
sudo yum install nginx -y  # CentOS/RHEL

# 2. 创建目录（如果不存在）
sudo mkdir -p /etc/nginx/sites-available
sudo mkdir -p /etc/nginx/sites-enabled

# 3. 重新运行部署脚本（已更新，会自动创建目录）
```
- 详细说明：[解决nginx目录不存在.md](解决nginx目录不存在.md)

### 10. "没有找到站点" 错误

**原因**：Nginx 配置未生效或站点未正确绑定

**解决方案**：
```bash
# 1. 修改 server_name 为匹配所有
sudo sed -i 's/server_name.*;/server_name _;/' /etc/nginx/sites-available/qk-paper-search

# 2. 创建软链接（如果不存在）
sudo ln -sf /etc/nginx/sites-available/qk-paper-search /etc/nginx/sites-enabled/

# 3. 禁用默认站点（可能干扰）
sudo mv /etc/nginx/sites-enabled/default /etc/nginx/sites-enabled/default.bak 2>/dev/null

# 4. 测试并重新加载
sudo nginx -t && sudo systemctl reload nginx

# 5. 确保应用服务运行
sudo systemctl restart qk-paper-search
```
- 详细说明：[解决没有找到站点错误.md](解决没有找到站点错误.md)

### 11. Nginx 502 Bad Gateway

**检查步骤**：
```bash
# 检查应用是否运行
sudo systemctl status qk-paper-search

# 检查端口是否监听
sudo netstat -tlnp | grep 8000

# 检查 Nginx 配置
sudo nginx -t

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

## 📋 部署前检查清单

- [ ] Python 3.8+ 已安装：`python3 --version`
- [ ] pip 已安装并升级到最新版本：`pip3 --version` 然后 `pip3 install --upgrade pip`
- [ ] 项目文件已完整上传到服务器（包括 `requirements.txt`）
- [ ] `requirements.txt` 文件存在于项目根目录
- [ ] 配置文件 `config.yml` 已创建（或已复制 `config.example.yml`）
- [ ] 脚本文件有执行权限：`chmod +x deploy/deploy.sh`
- [ ] 脚本行结束符已修复（如果从 Windows 上传）：`dos2unix deploy/deploy.sh`
- [ ] Nginx 已安装（如果使用）：`nginx -v`
- [ ] Nginx 目录存在：`ls -la /etc/nginx/sites-available/`（如果使用标准结构）
- [ ] 有 root 或 sudo 权限：`sudo whoami`

## 🛠️ 快速修复命令集合

```bash
# 一键修复常见问题
cd /opt/qk  # 替换为你的项目路径

# 修复权限和行结束符
chmod +x deploy/deploy.sh
sudo apt install dos2unix -y 2>/dev/null || sudo yum install dos2unix -y 2>/dev/null
dos2unix deploy/deploy.sh 2>/dev/null || sed -i 's/\r$//' deploy/deploy.sh

# 升级 pip（重要！避免包版本问题）
source venv/bin/activate 2>/dev/null || true  # 如果有虚拟环境
python3 -m pip install --upgrade pip

# 验证文件
ls -l deploy/deploy.sh
head -n 1 deploy/deploy.sh

# 尝试运行
sudo bash deploy/deploy.sh
```

## 📚 相关文档

- [解决nano命令不存在.md](解决nano命令不存在.md)
- [解决deploy脚本无法运行.md](解决deploy脚本无法运行.md)
- [解决requirements.txt未找到.md](解决requirements.txt未找到.md)
- [解决pip安装失败.md](解决pip安装失败.md)
- [快速修复pip安装问题.md](快速修复pip安装问题.md)
- [解决nginx目录不存在.md](解决nginx目录不存在.md)
- [解决没有找到站点错误.md](解决没有找到站点错误.md)
- [EDITOR_GUIDE.md](EDITOR_GUIDE.md) - 编辑器使用指南
- [DEPLOYMENT.md](DEPLOYMENT.md) - 完整部署文档
- [QUICK_START_DEPLOY.md](QUICK_START_DEPLOY.md) - 快速部署指南

## 💬 仍无法解决？

如果以上方法都无法解决问题，请：

1. 查看完整的错误信息
2. 检查系统日志：`sudo journalctl -xe`
3. 确认服务器系统版本：`cat /etc/os-release`
4. 检查 Python 和依赖是否正常：`python3 -m pip list`

